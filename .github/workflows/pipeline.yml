name: Build and Release
on: [push, pull_request]

jobs:
    build:
        name: Build on ${{ matrix.os }}
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                # We run the same steps on all three OS types simultaneously
                os: [ubuntu-latest, windows-latest, macos-latest]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            # --- 1. Install Dependencies ---
            - name: Install Dependencies (Linux)
              if: runner.os == 'Linux'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libwayland-dev libxkbcommon-dev xorg-dev libglu1-mesa-dev

            - name: Install Dependencies (Windows)
              if: runner.os == 'Windows'
              run: choco install nsis # Required for CPack to make .exe installers

            # --- 2. Build the Project ---
            - name: Configure CMake
              run: cmake -B build -DCMAKE_BUILD_TYPE=Release

            - name: Build
              run: cmake --build build --config Release

            # --- 3. Package the App ---
            - name: Run CPack (Windows & Mac)
              if: runner.os != 'Linux'
              working-directory: build
              run: cpack -C Release

            - name: Build AppImage (Linux)
              if: runner.os == 'Linux'
              run: |
                  # Install linuxdeploy
                  wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
                  chmod +x linuxdeploy-x86_64.AppImage
                  # Package the AppImage (Note: requires a .desktop file and icon in your project)
                  ./linuxdeploy-x86_64.AppImage --appdir build/install --output appimage

            # --- 4. Upload the results ---
            - name: Upload Artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: Build-${{ matrix.os }}
                  path: |
                      build/*.exe
                      build/*.dmg
                      *.AppImage
